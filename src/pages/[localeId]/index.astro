---
import Footer from '@components/app/Footer.astro';
import Header from '@components/app/Header.astro';
import CounterInput from '@components/app/home/CounterInput.astro';
import CounterOutputs from '@components/app/home/CounterOutputs.astro';
import Nav from '@components/app/home/Nav.astro';
import Article from '@components/ui/Article.astro';
import { INPUT } from '@config/input.ts';
import { LOCALE } from '@config/locale.ts';
import { getLocale, getLocaleMessages } from '@i18n/index.ts';
import PageLayout from '@layouts/PageLayout.astro';
import { keysOf } from '@utils/index.ts';
import { getEntry } from 'astro:content';
import { assert } from 'radashi';
import type { WithChildren } from '../../types.ts';

/**
 * Props for the main counting page.
 *
 * Explicitly disallows children as the page structure is predefined.
 */
type Props = WithChildren<false>;

/**
 * Conditionally loads a content entry by ID.
 *
 * @typeParam TId - The content entry ID type
 * @param id - The content entry ID to load
 * @param condition - Whether to load the entry
 * @param error - Optional error message if the entry doesn't exist
 * @returns The content entry if condition is true, otherwise false
 * @throws {Error} If the entry doesn't exist when condition is true
 */
async function getEntryIf<TId extends string>(
	id: TId,
	condition: boolean,
	error?: string,
) {
	if (!condition) {
		return false;
	}

	const entry = await getEntry(currentLocaleId, id);

	assert(entry, error);

	return entry;
}

const currentLocaleId = getLocale(Astro);
const msg = getLocaleMessages(currentLocaleId).site;
const inputPreloadVars = {
	id: INPUT.id,
	d: INPUT.default,
} as const;

const aboutEntry = await getEntry(currentLocaleId, 'about');
const relatedEntry = await getEntry(currentLocaleId, 'related');
const alertEntry = await getEntryIf(
	'experimental-locale-alert',
	LOCALE.map[currentLocaleId].wip,
	"'alert' entry does not exist",
);

assert(aboutEntry, "'about' entry does not exist");
assert(relatedEntry, "'related' entry does not exist");

/**
 * Generates static paths for all supported locales.
 *
 * @returns An array of path objects with locale parameters for static site generation
 */
export function getStaticPaths() {
	return keysOf(LOCALE.map).map((localeId) => ({ params: { localeId } }));
}
---

<PageLayout description={msg.longDescription}>
	<Header />
	<main>
		<section>
			<CounterInput />
			<CounterOutputs />
			<Nav />
			{alertEntry && <Article entry={alertEntry} />}
		</section>
		<Article entry={aboutEntry} />
		<Article entry={relatedEntry} />
	</main>
	<Footer />
	<!-- Preload the input text as soon as possible to prevent FOUC -->
	<script is:inline async type="module" define:vars={inputPreloadVars}>
		document.getElementById(id).value =
			new URLSearchParams(document.location.search).get(id) ??
			localStorage.getItem(id) ??
			d;
	</script>
</PageLayout>

<style>
	main {
		display: flex;
		flex-direction: column;
		gap: var(--p-lg);
		flex: 1;
		width: 100%;
		max-width: var(--max-w);
		padding: var(--p-md);
		box-sizing: border-box;
		view-transition-name: main;

		> article {
			padding: 0 var(--p-md);
		}
	}

	section {
		display: flex;
		flex-direction: column;
		gap: var(--p-md);
		view-transition-name: counter-section;
	}
</style>

<script>
	// Register store effects
	import '@effects/index.ts';
</script>
